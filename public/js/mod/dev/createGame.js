// Generated by CoffeeScript 1.9.3

/*
for /mod/dev/create/game

Handles new game submission
 */


/*
	For /signup form page

	Dependencies:
		JQeury
		CryptoJS
 */

(function() {
  var DEBUG_MODE, FORM_ERROR_CLASS, FORM_ID, FORM_RESULT_CLASS, POST_URL, displayEnd, endInError, endInSuccess, validateForm;

  FORM_ID = '#createGameForm';

  FORM_RESULT_CLASS = '.formResult';

  FORM_ERROR_CLASS = '.formError';

  POST_URL = '/mod/dev/create/game';

  DEBUG_MODE = false;

  $(FORM_ID).submit(function(e) {
    var formData, formValid;
    e.preventDefault();
    formData = {
      title: $("input[name='title']").val().trim(),
      description: $("textarea[name='description']").val().trim(),
      startDate: $("input[name='startDate']").val().trim(),
      endDate: $("input[name='endDate']").val().trim()
    };
    formValid = validateForm(formData);
    if (formValid !== true) {
      $('label[for=' + formValid["for"] + ']').addClass('hasInputError');
      $(FORM_ERROR_CLASS).text(formValid.msg);
      if (formValid["for"] === 'description') {
        $('textarea[name=' + formValid["for"] + ']').change(function() {
          $('label[for=' + $(this).attr('name') + ']').removeClass('hasInputError');
          return $(FORM_ERROR_CLASS).text("");
        });
      } else {
        $('input[name=' + formValid["for"] + ']').change(function() {
          $('label[for=' + $(this).attr('name') + ']').removeClass('hasInputError');
          return $(FORM_ERROR_CLASS).text("");
        });
      }
      $('#submit').shakeIt();
    } else {
      $('#submit').text('Submitting...');
      console.log('DATA= ' + JSON.stringify(formData, void 0, 2));
      $.ajax({
        type: 'POST',
        url: POST_URL,
        data: JSON.stringify(formData),
        contentType: 'application/json',
        success: function(res) {
          if (res.success) {
            return endInSuccess();
          } else {
            endInError(res.msg);
          }
        },
        error: function() {
          endInError();
        }
      });
    }
  });

  validateForm = function(fd) {
    var d1, d2, now;
    if (!fd.title) {
      return {
        "for": 'title',
        msg: 'Missing title!'
      };
    } else if (!fd.description) {
      return {
        "for": 'description',
        msg: 'Missing description!'
      };
    } else if (!fd.startDate) {
      return {
        "for": 'startDate',
        msg: 'Missing start date!'
      };
    } else if (!fd.endDate) {
      return {
        "for": 'endDate',
        msg: 'Missing end date!'
      };
    }
    d1 = Date.parse(fd.startDate);
    d2 = Date.parse(fd.endDate);
    now = Date.now() - 86400000;
    if (d1 < now) {
      return {
        "for": 'endDate',
        msg: 'Start date cannot be in the past!'
      };
    } else if (!(d1 < d2)) {
      return {
        "for": 'endDate',
        msg: 'End date must succeed start date!'
      };
    }
    return true;
  };

  endInError = function(msg) {
    var sub;
    sub = $('#submit');
    sub.fadeOut(500, function() {
      sub.text('Error!');
      sub.attr('disabled', 'true');
      sub.fadeIn(500, function() {});
      return displayEnd('<b>An unexpected error has occured:</b> ' + msg, 'Refresh this page and try resubmitting.');
    });
  };

  endInSuccess = function() {
    var sub;
    sub = $('#submit');
    sub.fadeOut(500, function() {
      sub.text('Success!');
      sub.attr('disabled', 'true');
      sub.fadeIn(500, function() {});
      return displayEnd('Game creation success!', 'Return to the <a href="/mod/dev">Game Development page</a> to add missions!');
    });
  };

  displayEnd = function(header, subtext) {
    var $newMsg;
    if (!DEBUG_MODE) {
      $(FORM_ID + ' input').attr('disabled', 'disabled');
      $(FORM_ID + ' checkbox').attr('disabled', 'disabled');
      $(FORM_ID + ' select').attr('disabled', 'disabled');
      $(FORM_ID).fadeTo(1000, 0, function() {
        var $newMsg;
        $newMsg = $("<div id='endDisplay'><h3>" + header + "</h3><h4>" + subtext + "</h4>");
        $newMsg.appendTo($(FORM_RESULT_CLASS)).fadeIn(1000, function() {
          return $("html, body").animate({
            scrollTop: 0
          }, 500);
        });
      });
    } else {
      $newMsg = $("<div id='endDisplay'><h3>" + header + "</h3><h4>" + subtext + "</h4>");
      $newMsg.appendTo($(FORM_RESULT_CLASS)).fadeIn(1000, function() {
        return $("html, body").animate({
          scrollTop: 0
        }, 500);
      });
      $('#submit').removeAttr('disabled').text('Retry');
    }
  };

}).call(this);
