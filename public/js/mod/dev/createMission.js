// Generated by CoffeeScript 1.9.0

/*
for /mod/dev/create/game

Handles new game submission
 */


/*
	For /signup form page

	Dependencies:
		JQeury
		CryptoJS
 */

(function() {
  var DEBUG_MODE, FORM_ERROR_CLASS, FORM_ID, FORM_RESULT_CLASS, POST_URL, displayEnd, endInError, endInSuccess, validateForm;

  FORM_ID = '#createMissionForm';

  FORM_RESULT_CLASS = '.formResult';

  FORM_ERROR_CLASS = '.formError';

  POST_URL = '/mod/dev/create/mission';

  DEBUG_MODE = false;

  $(FORM_ID).submit(function(e) {
    var formData, formValid;
    e.preventDefault();
    formData = {
      gameId: parseInt($('select[name="gameId"]').val()),
      title: $("input[name='title']").val().trim(),
      description: $("textarea[name='description']").val().trim(),
      startDate: $("input[name='startDate']").val().trim(),
      endDate: $("input[name='endDate']").val().trim(),
      visibility: {
        human: $('input[name="visibility"][data-group="human"]').is(':checked'),
        zombie: $('input[name="visibility"][data-group="zombie"]').is(':checked'),
        oz: $('input[name="visibility"][data-group="oz"]').is(':checked')
      },
      assignedTo: $('input[name="assignedTo"]:checked').val()
    };
    formValid = validateForm(formData);
    if (formValid !== true) {
      $('label[for=' + formValid["for"] + ']').addClass('hasInputError');
      $(FORM_ERROR_CLASS).text(formValid.msg);
      $('[name=' + formValid["for"] + ']').change(function() {
        $('label[for=' + $(this).attr('name') + ']').removeClass('hasInputError');
        return $(FORM_ERROR_CLASS).text("");
      });
      $('#submit').shakeIt();
    } else {
      $('#submit').text('Submitting...');
      formData.startDate = (formData.startDate.replace('T', ' ')) + ':00';
      formData.endDate = (formData.endDate.replace('T', ' ')) + ':00';
      console.log('DATA= ' + JSON.stringify(formData, void 0, 2));
      $.ajax({
        type: 'POST',
        url: POST_URL,
        data: JSON.stringify(formData),
        contentType: 'application/json',
        success: function(res) {
          if (res.success) {
            return endInSuccess();
          } else {
            endInError(res.msg);
          }
        },
        error: function() {
          endInError();
        }
      });
    }
  });

  $('input[name="assignedTo"]').click(function() {
    var roleId;
    roleId = $(this).val();
    return $('input[name="visibility"][value="' + roleId + '"]').prop('checked', true);
  });

  validateForm = function(fd) {
    var d1, d2, now;
    if (!fd.title) {
      return {
        "for": 'title',
        msg: 'Missing title!'
      };
    } else if (!fd.assignedTo) {
      return {
        "for": 'assignedTo',
        msg: 'Must assign mission to a group!'
      };
    } else if (!fd.description) {
      return {
        "for": 'description',
        msg: 'Missing description!'
      };
    } else if (!fd.startDate) {
      return {
        "for": 'startDate',
        msg: 'Missing start date!'
      };
    } else if (!fd.endDate) {
      return {
        "for": 'endDate',
        msg: 'Missing end date!'
      };
    }
    if (!fd.visibility.human && !fd.visibility.zombie && !fd.visibility.oz) {
      return {
        "for": 'visibility',
        msg: 'Must be visible to at least one group!'
      };
    } else if (!$('input[name="visibility"][value="' + fd.assignedTo + '"]').is(':checked')) {
      return {
        "for": 'visibility',
        msg: 'Must be visible to the assigned group!'
      };
    } else if (fd.visibility.human && fd.visibility.zombie) {
      if (!confirm('Are you sure you want to make this visible to both Humans and Zombies?')) {
        return {
          "for": 'visibility',
          msg: 'Remove the Human and/or Zombie group!'
        };
      }
    } else if (!fd.visibility.human && !fd.visibility.zombie) {
      if (!confirm('Are you sure you want to make this visible to OZ only?')) {
        return {
          "for": 'visibility',
          msg: 'Add the Human and/or Zombie group!'
        };
      }
    } else if (!fd.visibility.oz) {
      if (!confirm('Are you sure you want to make this invisible to the OZ group?')) {
        return {
          "for": 'visibility',
          msg: 'Add the OZ group!'
        };
      }
    }
    d1 = Date.parse(fd.startDate);
    d2 = Date.parse(fd.endDate);
    now = Date.now() - 86400000;
    if (d1 < now) {
      return {
        "for": 'endDate',
        msg: 'Start date cannot be in the past!'
      };
    } else if (!(d1 < d2)) {
      return {
        "for": 'endDate',
        msg: 'End date must succeed start date!'
      };
    }
    return true;
  };

  endInError = function(msg) {
    var sub;
    sub = $('#submit');
    sub.fadeOut(500, function() {
      sub.text('Error!');
      sub.attr('disabled', 'true');
      sub.fadeIn(500, function() {});
      return displayEnd('<b>An unexpected error has occured:</b> ' + msg, 'Refresh this page and try resubmitting.');
    });
  };

  endInSuccess = function() {
    var sub;
    sub = $('#submit');
    sub.fadeOut(500, function() {
      sub.text('Success!');
      sub.attr('disabled', 'true');
      sub.fadeIn(500, function() {});
      return displayEnd('Mission creation success!', 'Return to the <a href="/mod/dev">Game Development page</a> to view the new mission, or refresh this page to add another!');
    });
  };

  displayEnd = function(header, subtext) {
    var $newMsg;
    if (!DEBUG_MODE) {
      $(FORM_ID + ' input').attr('disabled', 'disabled');
      $(FORM_ID + ' checkbox').attr('disabled', 'disabled');
      $(FORM_ID + ' select').attr('disabled', 'disabled');
      $(FORM_ID).fadeTo(1000, 0, function() {
        var $newMsg;
        $newMsg = $("<div id='endDisplay'><h3>" + header + "</h3><h4>" + subtext + "</h4>");
        $newMsg.appendTo($(FORM_RESULT_CLASS)).fadeIn(1000, function() {
          return $("html, body").animate({
            scrollTop: 0
          }, 500);
        });
      });
    } else {
      $newMsg = $("<div id='endDisplay'><h3>" + header + "</h3><h4>" + subtext + "</h4>");
      $newMsg.appendTo($(FORM_RESULT_CLASS)).fadeIn(1000, function() {
        return $("html, body").animate({
          scrollTop: 0
        }, 500);
      });
      $('#submit').removeAttr('disabled').text('Retry');
    }
  };

}).call(this);
