// Generated by CoffeeScript 1.8.0

/*
	For /signup form page

	Dependencies:
		JQeury
		CryptoJS
 */

(function() {
  var DEBUG_MODE, FORM_ERROR_CLASS, FORM_ID, FORM_RESULT_CLASS, displayEnd, endInError, endInSuccess, validateForm;

  FORM_ID = '#signupForm';

  FORM_RESULT_CLASS = '.formResult';

  FORM_ERROR_CLASS = '.formError';

  DEBUG_MODE = false;

  $(FORM_ID).submit(function(e) {
    var formData, formValid;
    e.preventDefault();
    formData = {
      firstName: $("input[name='firstName']").val().trim(),
      lastName: $("input[name='lastName']").val().trim(),
      email: $("input[name='email']").val().trim(),
      emailConfirm: $("input[name='emailConfirm']").val().trim(),
      password: $("input[name='password']").val().trim(),
      passwordConfirm: $("input[name='passwordConfirm']").val().trim(),
      emailSubscribed: $("input[name='emailSubscribed']").is(':checked')
    };
    formValid = validateForm(formData);
    if (formValid !== true) {
      $('label[for=' + formValid["for"] + ']').addClass('hasInputError');
      $(FORM_ERROR_CLASS).text(formValid.msg);
      if (formValid["for"] === 'year') {
        $('select[name=' + formValid["for"] + ']').change(function() {
          $('label[for=' + $(this).attr('name') + ']').removeClass('hasInputError');
          return $(FORM_ERROR_CLASS).text("");
        });
      } else {
        $('input[name=' + formValid["for"] + ']').change(function() {
          $('label[for=' + $(this).attr('name') + ']').removeClass('hasInputError');
          return $(FORM_ERROR_CLASS).text("");
        });
      }
      $('#submit').shakeIt();
    } else {
      $('#submit').text('Submitting...');
      formData.emailConfirm = void 0;
      formData.passwordConfirm = void 0;
      $.ajax({
        type: 'POST',
        url: '/signup',
        data: JSON.stringify(formData),
        contentType: 'application/json',
        success: function(res) {
          if (res.success) {
            return endInSuccess();
          } else {
            endInError(res.msg);
          }
        },
        error: function() {
          endInError();
        }
      });
    }
  });

  validateForm = function(fd) {
    var regE;
    regE = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    if (!fd.firstName) {
      return {
        "for": 'firstName',
        msg: 'Missing first name!'
      };
    } else if (!fd.lastName) {
      return {
        "for": 'lastName',
        msg: 'Missing last name!'
      };
    } else if (!fd.email) {
      return {
        "for": 'email',
        msg: 'Missing email!'
      };
    } else if (!regE.test(fd.email)) {
      return {
        "for": 'email',
        msg: 'Valid email required!'
      };
    } else if (!fd.emailConfirm) {
      return {
        "for": 'email',
        msg: 'Missing email confirmation!'
      };
    } else if (fd.email !== fd.emailConfirm) {
      return {
        "for": 'email',
        msg: 'Emails do not match!'
      };
    } else if (!fd.password) {
      return {
        "for": 'password',
        msg: 'Missing password!'
      };
    } else if (!fd.passwordConfirm) {
      return {
        "for": 'password',
        msg: 'Missing password confirmation!'
      };
    } else if (fd.password !== fd.passwordConfirm) {
      return {
        "for": 'password',
        msg: 'Passwords do not match!'
      };
    }
    return true;
  };

  endInError = function(msg) {
    var sub;
    sub = $('#submit');
    sub.fadeOut(500, function() {
      sub.text('Error!');
      sub.attr('disabled', 'true');
      sub.fadeIn(500, function() {});
      return displayEnd('<b>An unexpected error has occured:</b> ' + msg, 'Refresh this window and try resubmitting.');
    });
  };

  endInSuccess = function() {
    var sub;
    sub = $('#submit');
    sub.fadeOut(500, function() {
      sub.text('Success!');
      sub.attr('disabled', 'true');
      sub.fadeIn(500, function() {});
      return displayEnd('Signup Complete!', 'You may login now');
    });
  };

  displayEnd = function(header, subtext) {
    var $newMsg;
    if (!DEBUG_MODE) {
      $(FORM_ID + ' input').attr('disabled', 'disabled');
      $(FORM_ID + ' checkbox').attr('disabled', 'disabled');
      $(FORM_ID + ' select').attr('disabled', 'disabled');
      $(FORM_ID).fadeTo(1000, 0, function() {
        var $newMsg;
        $newMsg = $("<div id='endDisplay'><h3>" + header + "</h3><h4>" + subtext + "</h4>");
        $newMsg.appendTo($(FORM_RESULT_CLASS)).fadeIn(1000, function() {
          return $("html, body").animate({
            scrollTop: 0
          }, 500);
        });
      });
    } else {
      $newMsg = $("<div id='endDisplay'><h3>" + header + "</h3><h4>" + subtext + "</h4>");
      $newMsg.appendTo($(FORM_RESULT_CLASS)).fadeIn(1000, function() {
        return $("html, body").animate({
          scrollTop: 0
        }, 500);
      });
      $('#submit').removeAttr('disabled').text('Retry');
    }
  };

}).call(this);
